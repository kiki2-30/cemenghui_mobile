import { NewsService } from '../services/NewsService'
import { News } from '../types/index'
import router from '@ohos.router'
import { StorageService } from '../services/StorageService'
import { RichTextView } from '../components/RichTextView'

interface NewsParams {
  newsId?: number
}

interface CompatibleNewsStats {
  views?: number;
  viewCount?: number;
  likes?: number;
  likeCount?: number;
  favorites?: number;
  favoriteCount?: number;
}

@Entry
@Component
struct NewsDetailPage {
  @State news: News | null = null
  @State loading: boolean = true
  @State isLiked: boolean = false
  @State isFavorited: boolean = false
  @State likeCount: number = 0
  @State favoriteCount: number = 0
  @State viewCount: number = 0
  
  private newsId: number = 0
  private newsService: NewsService = new NewsService()
  private userId: number = 0 // åŠ¨æ€è·å–ç”¨æˆ·ID

  aboutToAppear(): void {
    const params = router.getParams()
    if (typeof params === 'object' && params !== null) {
      const newsId = (params as NewsParams).newsId
      if (typeof newsId === 'number') {
        this.newsId = newsId
      }
    }
    StorageService.getInstance().getUserInfo().then(user => {
      this.userId = user?.userId ?? 0
      this.loadNewsDetail()
      this.loadNewsStats()
    })
  }

  async loadNewsDetail(): Promise<void> {
    try {
      const response = await this.newsService.getNewsDetail(this.newsId)
      if (response.code === 200) {
        this.news = response.data
        await this.newsService.recordView(this.newsId, this.userId)
        await this.loadInteractionStatus()
      }
    } catch (error) {
      console.error('åŠ è½½åŠ¨æ€è¯¦æƒ…å¤±è´¥:', error)
    } finally {
      this.loading = false
    }
  }

  async loadNewsStats(): Promise<void> {
    try {
      const res = await this.newsService.getNewsStats(this.newsId)
      if (res.code === 200 && res.data) {
        const raw = res.data as CompatibleNewsStats;
        this.viewCount = raw.views ?? raw.viewCount ?? 0
        this.likeCount = raw.likes ?? raw.likeCount ?? 0
        this.favoriteCount = raw.favorites ?? raw.favoriteCount ?? 0
      }
    } catch (error) {
      console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    }
  }

  async loadInteractionStatus(): Promise<void> {
    if (!this.userId) {
      this.isLiked = false
      this.isFavorited = false
      return
    }
    try {
      // é€‚é…åç«¯æ¥å£ç›´æ¥è¿”å›true/false
      const likeResponse = await this.newsService.getLikeStatus(this.newsId, this.userId)
      const favoriteResponse = await this.newsService.getFavoriteStatus(this.newsId, this.userId)
      if (likeResponse.code === 200) {
        this.isLiked = likeResponse.data === true
      }
      if (favoriteResponse.code === 200) {
        this.isFavorited = favoriteResponse.data === true
      }
    } catch (error) {
      console.error('è·å–äº¤äº’çŠ¶æ€å¤±è´¥:', error)
    }
  }

  async onLikeClick(): Promise<void> {
    // åˆ¤æ–­æœªç™»å½•è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
    const isLogin = await StorageService.getInstance().isLoggedIn()
    if (!isLogin) {
      router.pushUrl({ url: 'pages/LoginPage' })
      return
    }
    try {
      if (this.isLiked) {
        const response = await this.newsService.unlikeNews(this.newsId, this.userId)
        if (response.code === 200) {
          this.isLiked = false
          this.likeCount = Math.max(0, this.likeCount - 1)
        }
      } else {
        const response = await this.newsService.likeNews(this.newsId, this.userId)
        if (response.code === 200) {
          this.isLiked = true
          this.likeCount++
        }
      }
    } catch (error) {
      console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error)
    }
  }

  async onFavoriteClick(): Promise<void> {
    // åˆ¤æ–­æœªç™»å½•è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
    const isLogin = await StorageService.getInstance().isLoggedIn()
    if (!isLogin) {
      router.pushUrl({ url: 'pages/LoginPage' })
      return
    }
    try {
      if (this.isFavorited) {
        const response = await this.newsService.unfavoriteNews(this.newsId, this.userId)
        if (response.code === 200) {
          this.isFavorited = false
          this.favoriteCount = Math.max(0, this.favoriteCount - 1)
        }
      } else {
        const response = await this.newsService.favoriteNews(this.newsId, this.userId)
        if (response.code === 200) {
          this.isFavorited = true
          this.favoriteCount++
        }
      }
    } catch (error) {
      console.error('æ”¶è—æ“ä½œå¤±è´¥:', error)
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .fontSize(18)
          .fontColor('#333333')
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .onClick(() => router.back())
        Text('åŠ¨æ€è¯¦æƒ…')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
          .margin({ left: 16 })
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Center)
      if (this.loading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else if (this.news) {
        Scroll() {
          Column() {
            // æ ‡é¢˜
            Text(this.news?.title ?? 'æ— æ ‡é¢˜')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .margin({ bottom: 16 })
            // ä½œè€…ã€æ—¶é—´ã€æµè§ˆé‡
            Row() {
              Text(this.news?.publishTime ? this.formatDate(this.news.publishTime) : 'æœªçŸ¥æ—¶é—´')
                .fontSize(12)
                .fontColor('#999999')
              Text(`ä½œè€…: ${(this.news?.author?.toString() ?? 'æœªçŸ¥')}`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ left: 16 })
              Text(`æµè§ˆ: ${this.viewCount}`)
                .fontSize(12)
                .fontColor('#999999')
                .margin({ left: 16 })
            }
            .margin({ bottom: 20 })
            // å°é¢å›¾ç‰‡
            if (this.news?.coverImage && typeof this.news.coverImage === 'string' && this.news.coverImage.trim().length > 0) {
              Image(this.news.coverImage.trim())
                .width('100%')
                .height(180)
                .objectFit(ImageFit.Cover)
                .borderRadius(12)
                .margin({ bottom: 20 })
            }
            // äº¤äº’æŒ‰é’®ï¼ˆä¸Šç§»åˆ°å›¾ç‰‡ä¸‹æ–¹ï¼‰
            Row() {
              Button(this.isLiked ? 'â¤ï¸' : 'ğŸ¤')
                .width(80)
                .height(40)
                .fontSize(16)
                .fontColor(this.isLiked ? '#FF4757' : '#666666')
                .backgroundColor('#F0F0F0')
                .borderRadius(20)
                .onClick(() => this.onLikeClick())
              Text((this.likeCount ?? 0).toString())
                .fontSize(14)
                .fontColor('#666666')
                .margin({ left: 8, right: 16 })
              Button(this.isFavorited ? 'â­' : 'â˜†')
                .width(80)
                .height(40)
                .fontSize(16)
                .fontColor(this.isFavorited ? '#FFA500' : '#666666')
                .backgroundColor('#F0F0F0')
                .borderRadius(20)
                .onClick(() => this.onFavoriteClick())
              Text((this.favoriteCount ?? 0).toString())
                .fontSize(14)
                .fontColor('#666666')
                .margin({ left: 8 })
            }
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 20 })
            // å¯Œæ–‡æœ¬å†…å®¹
            if (this.news?.content) {
              RichTextView({
                content: this.news.content,
                style: {
                  fontSize: 15,
                  fontColor: '#333333',
                  lineHeight: 1.5,
                  padding: 0
                }
              })
              .width('100%')
              .height('auto')
              .margin({ bottom: 20 })
            }
          }
          .padding(16)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#FFFFFF')
      }
    }
    .width('100%')
    .height('100%')
  }

  formatDate(dateString: string): string {
    if (!dateString) return 'æœªçŸ¥æ—¶é—´'
    const date = new Date(dateString)
    if (isNaN(date.getTime())) return 'æœªçŸ¥æ—¶é—´'
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
  }
} 