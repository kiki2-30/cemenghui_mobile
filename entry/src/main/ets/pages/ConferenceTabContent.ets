import { ConferenceService } from '../services/ConferenceService'
import { Conference, ConferenceCategory, RawConference } from '../types/index'
import router from '@ohos.router'
import promptAction from '@ohos.promptAction'

@Component
export struct ConferenceTabContent {
  @State conferences: Conference[] = []
  @State categories: ConferenceCategory[] = []
  @State selectedCategoryId: number = 0
  @State loading: boolean = false
  @State refreshing: boolean = false
  @State currentPage: number = 0
  @State hasMore: boolean = true
  @State error: string = ''
  private conferenceService: ConferenceService = new ConferenceService()
  private refreshTimer: number = -1

  aboutToAppear(): void {
    this.loadCategories()
    this.loadConferences()
    // å¯åŠ¨å®šæ—¶åˆ·æ–°ï¼Œæ¯30ç§’åˆ·æ–°ä¸€æ¬¡
    this.startAutoRefresh()
  }

  aboutToDisappear(): void {
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.refreshTimer !== -1) {
      clearInterval(this.refreshTimer)
      this.refreshTimer = -1
    }
  }

  startAutoRefresh(): void {
    this.refreshTimer = setInterval(() => {
      console.info('[ConferenceTabContent] è‡ªåŠ¨åˆ·æ–°ä¼šè®®åˆ—è¡¨')
      this.loadConferences(true)
    }, 30000) // 30ç§’
  }

  async loadCategories(): Promise<void> {
    try {
      const response = await this.conferenceService.getCategories()
      if (response.code === 200) {
        this.categories = response.data
        this.categories.unshift({ id: 0, name: 'å…¨éƒ¨', description: 'æ‰€æœ‰åˆ†ç±»' })
      }
    } catch (error) {
      this.error = 'åŠ è½½åˆ†ç±»å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    }
  }

  async loadConferences(refresh: boolean = false): Promise<void> {
    if (this.loading) return
    
    this.loading = true
    this.error = ''
    if (refresh) {
      this.currentPage = 0
      this.hasMore = true
    }

    try {
      const response = await this.conferenceService.getConferences({
        page: this.currentPage,
        size: 10,
        categoryId: this.selectedCategoryId === 0 ? undefined : this.selectedCategoryId
      })
      
      console.info('[ConferenceTabContent] ä¼šè®®åˆ—è¡¨æ¥å£è¿”å›:', JSON.stringify(response))
      
      if (response.code === 200) {
        const list: Conference[] = (response.data.content as RawConference[]).map(this.toConference)
        console.info('[ConferenceTabContent] è½¬æ¢åçš„ä¼šè®®æ•°æ®:', JSON.stringify(list))
        if (refresh) {
          this.conferences = list
        } else {
          this.conferences = this.conferences.concat(list)
        }
        this.hasMore = this.currentPage < response.data.totalPages - 1
        this.currentPage++
      }
    } catch (error) {
      console.error('åŠ è½½ä¼šè®®åˆ—è¡¨å¤±è´¥:', error)
      this.error = 'åŠ è½½ä¼šè®®åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    } finally {
      this.loading = false
      this.refreshing = false
    }
  }

  onCategoryChange(categoryId: number): void {
    this.selectedCategoryId = categoryId
    this.loadConferences(true)
  }

  onRefresh(): void {
    this.refreshing = true
    this.loadConferences(true)
  }

  onLoadMore(): void {
    if (this.hasMore && !this.loading) {
      this.loadConferences()
    }
  }

  onConferenceClick(conference: Conference): void {
    router.pushUrl({
      url: 'pages/ConferenceDetailPage',
      params: { conferenceId: conference.id }
    })
  }

  formatDate(dateString: string): string {
    if (!dateString) return 'å¾…å®š'
    const date = new Date(dateString)
    return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
  }

  formatTime(dateString: string): string {
    if (!dateString) return '--:--'
    const date = new Date(dateString)
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
  }

  toConference(item: RawConference): Conference {
    console.info('[ConferenceTabContent] è½¬æ¢ä¼šè®®æ•°æ®:', JSON.stringify(item))
    console.info('[ConferenceTabContent] currentParticipantså€¼:', item.currentParticipants, typeof item.currentParticipants)
    
    return {
      id: item.conferenceId,
      title: item.title,
      description: item.description,
      content: item.content,
      startTime: item.startTime,
      endTime: item.endTime,
      location: item.location,
      maxParticipants: item.maxParticipants,
      registrationCount: item.currentParticipants,
      categoryId: item.categoryId ?? 0, // æ–°å¢
      categoryName: item.category && item.category.name ? item.category.name : '',
      status: item.status,
      organizer: item.organizer,
      coverImage: item.coverImage
    }
  }

  @Builder
  private ConferenceCard(conference: Conference) {
    Column() {
      Row() {
        Column() {
          Text(conference.title || 'ä¼šè®®æ ‡é¢˜')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(conference.description || 'ä¼šè®®æè¿°')
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 8 })
          
          if (conference.organizer) {
            Text(`ä¸»åŠ: ${conference.organizer}`)
              .fontSize(12)
              .fontColor('#666666')
              .margin({ top: 4 })
          }
          
          Row() {
            Text(conference.categoryName || 'åˆ†ç±»')
              .fontSize(12)
              .fontColor('#007DFF')
              .backgroundColor('#E6F3FF')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
            Text(`æŠ¥åäººæ•°: ${conference.registrationCount || 0}/${conference.maxParticipants}`)
              .fontSize(12)
              .fontColor('#999999')
              .margin({ left: 12 })
          }
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        Column() {
          Text(this.formatDate(conference.startTime))
            .fontSize(12)
            .fontColor('#999999')
          Text(this.formatTime(conference.startTime))
            .fontSize(14)
            .fontColor('#333333')
            .fontWeight(FontWeight.Bold)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.End)
      }
      Divider()
        .margin({ top: 12 })
        .color('#E0E0E0')
      // æ–°å¢ï¼šç¼–è¾‘ã€åˆ é™¤æŒ‰é’®
      Row() {
        Button('ç¼–è¾‘')
          .fontSize(14)
          .fontColor('#fff')
          .backgroundColor('#007DFF')
          .borderRadius(20)
          .onClick(() => {
            router.pushUrl({ url: 'pages/ConferenceEditPage', params: { mode: 'edit', conferenceId: conference.id } })
          })
        Button('åˆ é™¤')
          .fontSize(14)
          .fontColor('#fff')
          .backgroundColor('#FF4757')
          .borderRadius(20)
          .margin({ left: 16 })
          .onClick(() => {
            promptAction.showDialog({
              message: 'ç¡®å®šè¦åˆ é™¤è¯¥ä¼šè®®å—ï¼Ÿ',
              buttons: [ { text: 'å–æ¶ˆ', color: '#666666' }, { text: 'ç¡®å®š', color: '#FF4757' } ]
            }).then(result => {
              if (result.index === 1) {
                this.deleteConference(conference.id)
              }
            })
          })
      }
      .margin({ top: 12 })
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 16, right: 16, top: 8, bottom: 8 })
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .onClick(() => this.onConferenceClick(conference))
  }

  async deleteConference(conferenceId: number) {
    try {
      const res = await this.conferenceService.deleteConference(conferenceId)
      if (res.code === 200) {
        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' })
        this.loadConferences(true)
      } else {
        promptAction.showToast({ message: res.message || 'åˆ é™¤å¤±è´¥' })
      }
    } catch (e) {
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' })
    }
  }

  @Builder
  private ConferenceList() {
    Column() {
      Scroll() {
        Row() {
          ForEach(this.categories, (category: ConferenceCategory) => {
            Button(category.name)
              .fontSize(14)
              .fontColor(this.selectedCategoryId === category.id ? '#FFFFFF' : '#333333')
              .backgroundColor(this.selectedCategoryId === category.id ? '#007DFF' : '#F0F0F0')
              .borderRadius(20)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .margin({ right: 12 })
              .onClick(() => this.onCategoryChange(category.id))
          })
        }
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .backgroundColor('#FFFFFF')
      Refresh({ refreshing: $$this.refreshing, offset: 120, friction: 100 }) {
        List() {
          if (this.error) {
            ListItem() {
              Column() {
                Text('âš ï¸')
                  .fontSize(48)
                  .fontColor('#FFA500')
                Text(this.error)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 8 })
                Button('é‡è¯•')
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#007DFF')
                  .borderRadius(20)
                  .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .margin({ top: 16 })
                  .onClick(() => this.loadConferences(true))
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            }
          } else if (this.conferences.length === 0 && !this.loading) {
            ListItem() {
              Column() {
                Text('ğŸ“‹')
                  .fontSize(48)
                  .fontColor('#CCCCCC')
                Text('æš‚æ— ä¼šè®®ä¿¡æ¯')
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ top: 8 })
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            }
          } else {
            ForEach(this.conferences, (conference: Conference) => {
              ListItem() {
                this.ConferenceCard(conference)
              }
            })
          }
          if (this.loading) {
            ListItem() {
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                Text('åŠ è½½ä¸­...')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ left: 8 })
              }
              .width('100%')
              .height(60)
              .justifyContent(FlexAlign.Center)
            }
          }
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F5F5')
        .onReachEnd(() => this.onLoadMore())
      }
    }
    .width('100%')
    .height('100%')
  }

  build() {
    Column() {
      // æ–°å¢ä¼šè®®æŒ‰é’®
      Row() {
        Button('æ–°å¢ä¼šè®®')
          .fontSize(16)
          .fontColor('#fff')
          .backgroundColor('#007DFF')
          .borderRadius(20)
          .margin({ left: 16, top: 16, bottom: 8 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/ConferenceEditPage', params: { mode: 'add' } })
          })
      }
      this.ConferenceList()
    }
    .width('100%')
    .height('100%')
  }
} 