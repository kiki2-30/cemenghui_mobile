import { NewsService } from '../services/NewsService'
import { News } from '../types/index'
import router from '@ohos.router'
import { StorageService } from '../services/StorageService'
import promptAction from '@ohos.promptAction'
import { NewsTabContent } from './NewsTabContent'

@Entry
@Component
struct NewsPage {
  @State newsList: News[] = []
  @State loading: boolean = false
  @State refreshing: boolean = false
  @State currentPage: number = 0
  @State hasMore: boolean = true
  @State searchKeyword: string = ''
  @State isSearching: boolean = false
  @State error: string = ''
  @State isSuperAdmin: boolean = false
  private newsService: NewsService = new NewsService()

  aboutToAppear(): void {
    StorageService.getInstance().getUserInfo().then(user => {
      this.isSuperAdmin = user?.role === 'SUPER_ADMIN'
      this.loadNews()
    })
  }

  async loadNews(refresh: boolean = false): Promise<void> {
    if (this.loading) return
    this.loading = true
    this.error = ''
    if (refresh) {
      this.currentPage = 0
      this.hasMore = true
    }
    try {
      const response = await this.newsService.getNewsList({
        page: this.currentPage,
        size: 10,
        keyword: this.searchKeyword || undefined
      })
      if (response.code === 200) {
        if (refresh) {
          this.newsList = response.data.content
        } else {
          this.newsList = this.newsList.concat(response.data.content)
        }
        this.hasMore = this.currentPage < response.data.totalPages - 1
        this.currentPage++
      }
    } catch (error) {
      console.error('åŠ è½½è¡Œä¸šåŠ¨æ€å¤±è´¥:', error)
      this.error = 'åŠ è½½è¡Œä¸šåŠ¨æ€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥'
    } finally {
      this.loading = false
      this.refreshing = false
    }
  }

  onSearch(): void {
    this.isSearching = true
    this.loadNews(true)
  }

  onRefresh(): void {
    this.refreshing = true
    this.loadNews(true)
  }

  onLoadMore(): void {
    if (this.hasMore && !this.loading) {
      this.loadNews()
    }
  }

  onNewsClick(news: News): void {
    router.pushUrl({
      url: 'pages/NewsDetailPage',
      params: { newsId: news.newsId }
    })
  }

  async onAddNews() {
    router.pushUrl({ url: 'pages/NewsEditPage', params: { mode: 'add' } })
  }

  async onEditNews(newsId: number) {
    router.pushUrl({ url: 'pages/NewsEditPage', params: { mode: 'edit', newsId } })
  }

  async onDeleteNews(newsId: number) {
    const result: promptAction.ShowDialogSuccessResponse = await promptAction.showDialog({
      message: 'ç¡®å®šè¦åˆ é™¤è¯¥åŠ¨æ€å—ï¼Ÿ',
      buttons: [ { text: 'å–æ¶ˆ', color: '#666666' }, { text: 'ç¡®å®š', color: '#FF4757' } ]
    })
    if (result.index === 1) {
      const res = await this.newsService.deleteNews(newsId)
      if (res.code === 200) {
        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' })
        this.loadNews(true)
      } else {
        promptAction.showToast({ message: res.message || 'åˆ é™¤å¤±è´¥' })
      }
    }
  }

  async onToggleStatus(news: News) {
    const newStatus = news.status === 1 ? 0 : 1
    const result: promptAction.ShowDialogSuccessResponse = await promptAction.showDialog({
      message: `ç¡®å®šè¦${newStatus === 1 ? 'ä¸Šæž¶' : 'ä¸‹æž¶'}è¯¥åŠ¨æ€å—ï¼Ÿ`,
      buttons: [ { text: 'å–æ¶ˆ', color: '#666666' }, { text: 'ç¡®å®š', color: '#FF4757' } ]
    })
    if (result.index === 1) {
      const res = await this.newsService.updateNewsStatus(news.newsId, newStatus)
      if (res.code === 200) {
        promptAction.showToast({ message: `${newStatus === 1 ? 'ä¸Šæž¶' : 'ä¸‹æž¶'}æˆåŠŸ` })
        this.loadNews(true)
      } else {
        promptAction.showToast({ message: res.message || 'æ“ä½œå¤±è´¥' })
      }
    }
  }

  async onTopNews(news: News) {
    const newTop = news.top ? 0 : 1
    const result: promptAction.ShowDialogSuccessResponse = await promptAction.showDialog({
      message: `ç¡®å®šè¦${newTop === 1 ? 'ç½®é¡¶' : 'å–æ¶ˆç½®é¡¶'}è¯¥åŠ¨æ€å—ï¼Ÿ`,
      buttons: [ { text: 'å–æ¶ˆ', color: '#666666' }, { text: 'ç¡®å®š', color: '#FF4757' } ]
    })
    if (result.index === 1) {
      const res = await this.newsService.topNews(news.newsId, newTop)
      if (res.code === 200) {
        promptAction.showToast({ message: `${newTop === 1 ? 'ç½®é¡¶' : 'å–æ¶ˆç½®é¡¶'}æˆåŠŸ` })
        this.loadNews(true)
      } else {
        promptAction.showToast({ message: res.message || 'æ“ä½œå¤±è´¥' })
      }
    }
  }

  formatDate(dateString: string): string {
    if (!dateString) return 'æœªçŸ¥æ—¶é—´'
    const date = new Date(dateString)
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`
  }

  formatTime(dateString: string): string {
    if (!dateString) return '--:--'
    const date = new Date(dateString)
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
  }

  @Builder
  private NewsCard(news: News) {
    Column() {
      Row() {
        Column() {
          Text(news.title || 'åŠ¨æ€æ ‡é¢˜')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
          Text(news.summary || 'åŠ¨æ€æ‘˜è¦')
            .fontSize(14)
            .fontColor('#666666')
            .maxLines(3)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: 8 })
          Row() {
            Text(this.formatDate(news.publishTime))
              .fontSize(12)
              .fontColor('#999999')
            Text(this.formatTime(news.publishTime))
              .fontSize(12)
              .fontColor('#999999')
              .margin({ left: 12 })
          }
          .margin({ top: 8 })
        }
        .layoutWeight(1)
        if (this.isSuperAdmin) {
          Column() {
            Button('ç¼–è¾‘').fontSize(13).width(60).height(28).margin({ bottom: 4 }).onClick(() => this.onEditNews(news.newsId))
            Button('åˆ é™¤').fontSize(13).width(60).height(28).margin({ bottom: 4 }).onClick(() => this.onDeleteNews(news.newsId))
            Button(news.status === 1 ? 'ä¸‹æž¶' : 'ä¸Šæž¶').fontSize(13).width(60).height(28).margin({ bottom: 4 }).onClick(() => this.onToggleStatus(news))
            Button(news.top ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶').fontSize(13).width(60).height(28).onClick(() => this.onTopNews(news))
          }
        }
      }
      Divider()
        .margin({ top: 12 })
        .color('#E0E0E0')
    }
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(8)
    .margin({ left: 16, right: 16, top: 8, bottom: 8 })
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .onClick(() => this.onNewsClick(news))
  }

  @Builder
  private NewsList() {
    Column() {
      // é¡¶éƒ¨æµ‹è¯•è·³è½¬æŒ‰é’®
      Row() {
        Button('æµ‹è¯•è·³è½¬')
          .fontSize(15)
          .fontColor('#fff')
          .backgroundColor('#00B386')
          .borderRadius(20)
          .width(120)
          .height(40)
          .margin({ left: 16, top: 12, bottom: 4 })
          .onClick(() => router.pushUrl({ url: 'pages/TestPage' }))
      }
      if (this.isSuperAdmin) {
        Row() {
          Button('æ–°å¢žåŠ¨æ€')
            .fontSize(15)
            .fontColor('#fff')
            .backgroundColor('#FF4757')
            .borderRadius(20)
            .width(120)
            .height(40)
            .margin({ left: 16, top: 12, bottom: 4 })
            .onClick(() => this.onAddNews())
        }
      }
      Row() {
        TextInput({ placeholder: 'æœç´¢è¡Œä¸šåŠ¨æ€...', text: this.searchKeyword })
          .width('100%')
          .height(40)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 16, right: 16 })
          .onChange((value: string) => {
            this.searchKeyword = value
          })
          .onSubmit(() => this.onSearch())
        Button('æœç´¢')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#007DFF')
          .borderRadius(20)
          .width(60)
          .height(40)
          .margin({ left: 12 })
          .onClick(() => this.onSearch())
      }
      .padding(16)
      .backgroundColor('#FFFFFF')
      Refresh({ refreshing: $$this.refreshing, offset: 120, friction: 100 }) {
        List() {
          if (this.error) {
            ListItem() {
              Column() {
                Text('âš ï¸')
                  .fontSize(48)
                  .fontColor('#FFA500')
                Text(this.error)
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ top: 8 })
                Button('é‡è¯•')
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#007DFF')
                  .borderRadius(20)
                  .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                  .margin({ top: 16 })
                  .onClick(() => this.loadNews(true))
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            }
          } else if (this.newsList.length === 0 && !this.loading) {
            ListItem() {
              Column() {
                Text('ðŸ“°')
                  .fontSize(48)
                  .fontColor('#CCCCCC')
                Text('æš‚æ— è¡Œä¸šåŠ¨æ€')
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ top: 8 })
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            }
          } else {
            ForEach(this.newsList, (news: News) => {
              ListItem() {
                this.NewsCard(news)
              }
            })
          }
          if (this.loading) {
            ListItem() {
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                Text('åŠ è½½ä¸­...')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ left: 8 })
              }
              .width('100%')
              .height(60)
              .justifyContent(FlexAlign.Center)
            }
          }
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#F5F5F5')
        .onReachEnd(() => this.onLoadMore())
      }
    }
    .width('100%')
    .height('100%')
  }

  build() {
    Column() {
      NewsTabContent()
    }
    .width('100%')
    .height('100%')
  }
} 